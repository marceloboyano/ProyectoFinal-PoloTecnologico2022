@model IEnumerable<int[,]>

@{
    var count = 1;
}


<div class="text-center">
    <h1 class=" display-4 fw-bolder">Bienvenidos al Juego</h1>
</div>

<div class="container text-center">
    <div class="row  ">
        @foreach (var carton in @Model)
        {
            <vc:lottery-card-row id=@count matrix=carton />
            count++;
        }
    </div>
    <br />
    <div>
        <button class="btn btn-success " id="lanzarBolilla">Lanzar Bolilla</button>
    </div>
</div>

<div class="container text-center">
    <div class="row flex-lg-row flex-sm-column  flex-sm-wrap-reverse  ">
        <div class="col display-5 fw-bolder " id="bolilla">
            Bolilla:
        </div>
        <div class="col  display-5 fw-bolder" id="ganador">
            Cartón Ganador:
        </div>
    </div>
</div>
<div id="modal">
    <div id="modal-content">
        <span id="close-button">&times;</span>
        <p class="display-4 fw-bold text-center"> El Juego ha Terminado!!!</p>
    </div>
</div>
<script type="text/javascript">

    var winners = [];

    var cartones = {
        carton1: {
            id: 1,
            counter: 0
        },
        carton2: {
            id: 2,
            counter: 0
        },
        carton3: {
            id: 3,
            counter: 0
        },
        carton4: {
            id: 4,
            counter: 0
        },
    }
    function chequearGanadores() {
        const fetchCalls = [];

        Object.keys(cartones).forEach(async c => {
            if (cartones[c].counter === 15) {
                console.log("aca entro");
                winners.push(cartones[c].id);
                fetchCalls.push(fetch("Api/Winner/Cartones", {
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    method: "POST",
                    body: JSON.stringify(winners)

                }));
            }
        });
        console.log(fetchCalls.length);
        if (fetchCalls.length > 0) {
            Promise.all(fetchCalls)
                .then(() => {
                    document.querySelector("#ganador").innerHTML = `Los Ganadores son. Carton:${winners.map(x => x)}`;
                    document.querySelector("#lanzarBolilla").disabled = true;
                    showModal();
                })
                .catch((error) => {
                    console.error(error);
                });
        }
    }


    // Obtener los elementos modal y el botón de cierre
    var modal = document.getElementById("modal");
    var closeButton = document.getElementById("close-button");

    // Función para mostrar la ventana modal
    function showModal() {
        modal.style.display = "block";
    }

    // Función para cerrar la ventana modal
    function closeModal() {      
        modal.style.display = "none";
    }

    // Escuchar eventos de clic en el botón de cierre
    closeButton.addEventListener("click", closeModal);

    

    document.querySelector("#lanzarBolilla").addEventListener("click", async function () {
        await fetch("Api/Bolillero")
            .then(response => response.json())
            .then(data => {
                let bolillas = document.querySelectorAll(".bolilla");
                bolillas.forEach(function (b) {
                    if (Number(b.textContent) === data) {
                        b.classList.toggle("paint");
                    }
                });

                $("#bolilla").text(`Bolilla: ${data}`);

                cartones.carton1.counter = $('#1').find('.paint').length
                cartones.carton2.counter = $('#2').find('.paint').length
                cartones.carton3.counter = $('#3').find('.paint').length
                cartones.carton4.counter = $('#4').find('.paint').length
               

                chequearGanadores();
            })
            .catch(error => console.error(error));

    });
</script>
